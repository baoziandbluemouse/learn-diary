---
date: 2025-08-05
---

# [D - Takahashi's Expectation](https://atcoder.jp/contests/abc417/tasks/abc417_d)

- 不难想出，在数据量较小的情况下，可以使用动态规划来解决，首先我们**简化数据量**

- x<=1000时，定义状态$dp[i][j]$为如果接收第i个礼物时心情值为j,最终心情值为多少

- 状态方程如下：

$$dp[i][j]=\begin{cases}
  & dp[i+1][j+A_{i}] (j\le P_i)  \\
  & dp[i+1][max(0,j-B_i)](j>P_i)
\end{cases}$$


如此，初始情绪为x时，答案即为$dp[1][x]$

并且，由于$a_{i} \le 500$,且j只有在小于等于500的情况下才有可能增加，所以$j+a_{i}\le 1000$

我们可以发现，第二个[]的数据范围是<=1000,但x数据范围明显就比1000要大

当**x>1000时要如何处理?**

观察题目，当x>500时，接下来心情只有可能减少，直到心情值<=500并且遇到一个比他大的$p_i$

那么当x>1000时，一定会经过多次减少，直到心情值<=1000，假设**这个多次减少的总和为S,减少的次数为pos**,那么最终我们可以视为初始情绪为$x-S$,这个值一定<=1000,

```cpp
//x - s[i] <= 1000  -> s[i] >= x-1000
//转换一下，可以直接用lower_bound找到s[i](因为s[i]有序)
```

**最终答案就是**$dp[pos+1][x-S]$

```cpp
#include <iostream>

#include <map>

#include <algorithm>

using namespace std;

using ll = long long;

const int N = 1e4 + 10;

int dp[N][1005]; // dp[i][j]代表接收第i个礼物时，心情值为j，最终心情值为多少

int p[N], a[N], b[N], s[N];

int main()

{

    int n;

    cin >> n;

    for (int i = 1; i <= n; i++)

    {

        cin >> p[i] >> a[i] >> b[i];

    }

    for (int i = 1; i <= n; i++)

    {

        s[i] = s[i - 1] + b[i];

    }

    for (int i = 1; i <= 1000; i++)

    {

        dp[n + 1][i] = i;

    }

    for (int i = n; i >= 1; i--)

    {

        for (int j = 0; j <= 1000; j++)

        {

            if (j <= p[i])

            {

                dp[i][j] = dp[i + 1][j + a[i]];

            }

            else

            {

                dp[i][j] = dp[i + 1][max(0, j - b[i])];

            }

        }

    }

    int q;

    cin >> q;

    while (q--)

    {

        int x;

        cin >> x;

        if (x <= 1000)

        {

            cout << dp[1][x] << "\n";

        }

        else

        {

            int pos = lower_bound(s + 1, s + n + 1, x - 1000) - s;

            if (pos == n + 1)

                cout << x - s[n] << "\n"; // 代表x会一直减少，直到收完所有礼物

            else

                cout << dp[pos + 1][x - s[pos]] << "\n";

        }

    }

    return 0;

}
```

